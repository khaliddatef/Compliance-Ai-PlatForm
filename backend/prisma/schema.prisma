datasource db {
  provider = "sqlite"
}

generator client {
  provider = "prisma-client-js"
}

model Conversation {
  id        String   @id @default(cuid())
  title     String
  userId    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages  Message[]
  documents Document[]
  customerVectorStoreId  String?
  evaluations EvidenceEvaluation[]
  user      User? @relation(fields: [userId], references: [id], onDelete: SetNull)
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  role           String // "user" | "assistant"
  content        String
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

model Document {
  id             String   @id @default(cuid())
  conversationId String
  standard       String
  kind String @default("CUSTOMER")
  originalName   String
  mimeType       String
  sizeBytes      Int
  storagePath    String
  docType        String?
  matchControlId String?
  matchStatus    String?
  matchNote      String?
  matchRecommendations Json?
  reviewedAt     DateTime?
  submittedAt    DateTime?
  createdAt      DateTime @default(now())

  conversation Conversation    @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  chunks       DocumentChunk[]

  @@index([conversationId])
}

model DocumentChunk {
  id         String   @id @default(cuid())
  documentId String
  chunkIndex Int
  text       String
  embedding  Json?
  createdAt  DateTime @default(now())

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
}

model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String
  role         String   @default("USER")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  conversations Conversation[]
}

model ControlTopic {
  id          String   @id @default(cuid())
  standard    String
  title       String
  description String?
  mode        String   @default("continuous")
  status      String   @default("enabled")
  priority    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  controls ControlDefinition[]

  @@index([standard])
}

model ControlDefinition {
  id          String   @id @default(cuid())
  topicId     String
  controlCode String
  title       String
  description String?
  isoMappings Json?
  ownerRole   String?
  status      String   @default("enabled")
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  topic          ControlTopic  @relation(fields: [topicId], references: [id], onDelete: Cascade)
  testComponents TestComponent[]

  @@index([controlCode])
  @@index([topicId])
}

model TestComponent {
  id                String   @id @default(cuid())
  controlId         String
  requirement       String
  evidenceTypes     Json?
  acceptanceCriteria String?
  partialCriteria   String?
  rejectCriteria    String?
  sortOrder         Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  control ControlDefinition @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@index([controlId])
}

model EvidenceEvaluation {
  id             String   @id @default(cuid())
  conversationId String
  standard       String
  controlId      String
  status         String
  summary        String
  satisfied      Json?
  missing        Json?
  recommendations Json?
  citations      Json?
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([controlId])
}
