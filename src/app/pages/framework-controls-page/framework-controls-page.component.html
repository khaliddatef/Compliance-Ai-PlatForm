<section class="page">
  <div class="panel">
    <div class="panel-header">
      <div>
        <h3>{{ frameworkLabel }} Topics</h3>
        <p class="sub">Topics sourced from the Knowledge Base.</p>
      </div>
      <div class="header-actions">
        <button class="ghost-btn" type="button" (click)="goBackToFrameworks()">Back to Frameworks</button>
        <button class="ghost-btn" type="button" *ngIf="isAdmin" (click)="openAssignTopic()">
          Assign topic
        </button>
        <button class="ghost-btn" type="button" *ngIf="isAdmin" (click)="showNewTopic = !showNewTopic">
          {{ showNewTopic ? 'Close' : 'New topic' }}
        </button>
      </div>
    </div>

    <div class="draft-card" *ngIf="showNewTopic && isAdmin">
      <h5>New topic</h5>
      <div class="field">
        <label>Title</label>
        <input type="text" [(ngModel)]="topicDraft.title" placeholder="Access control" />
      </div>
      <div class="field">
        <label>Description</label>
        <textarea rows="2" [(ngModel)]="topicDraft.description" placeholder="Short summary"></textarea>
      </div>
      <div class="field-row">
        <label>
          Mode
          <select [(ngModel)]="topicDraft.mode">
            <option value="continuous">Continuous</option>
            <option value="open">Open</option>
          </select>
        </label>
        <label>
          Status
          <select [(ngModel)]="topicDraft.status">
            <option value="enabled">Enabled</option>
            <option value="disabled">Disabled</option>
          </select>
        </label>
      </div>
      <button
        class="ghost-btn"
        type="button"
        (click)="createTopic()"
        [disabled]="creatingTopic || !topicDraft.title.trim()"
      >
        {{ creatingTopic ? 'Adding...' : 'Add topic' }}
      </button>
    </div>

    <div class="topics" *ngIf="!loading">
      <article
        class="topic-card"
        *ngFor="let topic of topics"
        role="button"
        tabindex="0"
        (click)="onTopicCardClick(topic, $event)"
        (keydown)="onTopicCardKeydown(topic, $event)"
      >
        <header class="topic-header">
          <div>
            <h4>{{ topic.title }}</h4>
            <p class="meta">{{ topic.controlCount || 0 }} controls</p>
            <p class="meta" *ngIf="topic.description">{{ topic.description }}</p>
          </div>
          <div class="topic-actions" (click)="$event.stopPropagation()">
            <div class="topic-actions-inline">
              <ng-container *ngIf="isAdmin">
                <button class="ghost-btn" type="button" (click)="startEditTopic(topic)" *ngIf="editingTopicId !== topic.id">Edit</button>
                <button class="ghost-btn" type="button" (click)="saveTopic(topic)" *ngIf="editingTopicId === topic.id">Save</button>
                <button class="ghost-btn" type="button" (click)="cancelEditTopic()" *ngIf="editingTopicId === topic.id">Cancel</button>
                <button
                  class="ghost-btn danger"
                  type="button"
                  [disabled]="deletingTopicIds.has(topic.id)"
                  (click)="deleteTopic(topic)"
                >
                  {{ deletingTopicIds.has(topic.id) ? 'Deleting...' : 'Delete' }}
                </button>
              </ng-container>
            </div>
            <div class="topic-actions-menu" (click)="$event.stopPropagation()">
              <button class="ghost-btn menu-btn" type="button" (click)="toggleTopicMenu(topic.id, $event)">Actions</button>
              <div class="menu" *ngIf="openTopicMenuId === topic.id">
                <ng-container *ngIf="isAdmin">
                  <button
                    class="menu-item"
                    type="button"
                    (click)="startEditTopic(topic); closeTopicMenu()"
                    *ngIf="editingTopicId !== topic.id"
                  >
                    Edit
                  </button>
                  <button
                    class="menu-item"
                    type="button"
                    (click)="saveTopic(topic); closeTopicMenu()"
                    *ngIf="editingTopicId === topic.id"
                  >
                    Save
                  </button>
                  <button
                    class="menu-item"
                    type="button"
                    (click)="cancelEditTopic(); closeTopicMenu()"
                    *ngIf="editingTopicId === topic.id"
                  >
                    Cancel
                  </button>
                  <button
                    class="menu-item danger"
                    type="button"
                    [disabled]="deletingTopicIds.has(topic.id)"
                    (click)="deleteTopic(topic); closeTopicMenu()"
                  >
                    {{ deletingTopicIds.has(topic.id) ? 'Deleting...' : 'Delete' }}
                  </button>
                </ng-container>
              </div>
            </div>
          </div>
        </header>

        <div class="topic-edit" *ngIf="editingTopicId === topic.id && topicEdit" (click)="$event.stopPropagation()">
          <div class="field">
            <label>Title</label>
            <input type="text" [(ngModel)]="topicEdit.title" />
          </div>
          <div class="field">
            <label>Description</label>
            <textarea rows="2" [(ngModel)]="topicEdit.description"></textarea>
          </div>
          <div class="field-row">
            <label>
              Mode
              <select [(ngModel)]="topicEdit.mode">
                <option value="continuous">Continuous</option>
                <option value="open">Open</option>
              </select>
            </label>
            <label>
              Status
              <select [(ngModel)]="topicEdit.status">
                <option value="enabled">Enabled</option>
                <option value="disabled">Disabled</option>
              </select>
            </label>
          </div>
        </div>

      </article>
    </div>

    <p class="empty" *ngIf="loading">Loading topicsâ€¦</p>
    <p class="empty" *ngIf="!loading && !topics.length && !error">No topics yet.</p>
    <p class="empty error" *ngIf="error">{{ error }}</p>
  </div>
</section>
