<section class="page">
  <div class="panel">
    <div class="panel-header">
      <div>
        <h3>Assign control</h3>
        <p class="sub">Assign existing controls to another framework.</p>
      </div>
      <button class="ghost-btn" type="button" (click)="backToControlKb()">Back to Control KB</button>
    </div>

    <div class="form-card" *ngIf="!loading; else loadingState">
      <label>
        Target framework
        <select [(ngModel)]="targetFramework" (change)="onTargetFrameworkChange()">
          <option value="" disabled>Select framework</option>
          <option *ngFor="let framework of frameworks" [value]="framework.framework">
            {{ framework.framework }}
          </option>
        </select>
      </label>

      <label>
        Target topic (optional)
        <select [(ngModel)]="topicId">
          <option value="">No related topic</option>
          <option *ngFor="let topic of topics" [value]="topic.id">{{ topic.title }}</option>
        </select>
      </label>

      <p class="hint" *ngIf="selectedTopicLabel">
        Control will be assigned to topic:
        <strong>{{ selectedTopicLabel }}</strong>
      </p>

      <label>
        Controls source framework
        <select [(ngModel)]="sourceFramework" (change)="refreshControls()">
          <option value="all">All frameworks</option>
          <option *ngFor="let framework of sourceFrameworkOptions" [value]="framework">
            {{ framework }}
          </option>
        </select>
      </label>

      <label>Search existing controls</label>
      <div class="search-row">
        <input
          type="search"
          [(ngModel)]="controlQuery"
          placeholder="Type control code or title"
          (keyup.enter)="refreshControls()"
        />
        <button class="ghost-btn" type="button" (click)="refreshControls()" [disabled]="loadingControls">
          {{ loadingControls ? 'Refreshing...' : 'Refresh' }}
        </button>
      </div>

      <p class="hint">Loaded controls: {{ loadedControls }}</p>

      <label>
        Control
        <select [(ngModel)]="selectedControlId" (change)="onControlChanged()">
          <option value="" disabled>Select control</option>
          <option *ngFor="let control of controls" [value]="control.id">
            {{ getControlLabel(control) }}
          </option>
        </select>
      </label>

      <label>
        Reference code
        <input
          type="text"
          [(ngModel)]="referenceCode"
          placeholder="ISO-27001 A.5.1, RQ-05-02.a..."
        />
      </label>

      <button class="primary-btn assign-btn" type="button" (click)="assignControl()" [disabled]="!canAssign">
        {{ saving ? 'Assigning...' : 'Assign control' }}
      </button>

      <p class="notice success" *ngIf="notice">{{ notice }}</p>
      <p class="notice error" *ngIf="error">{{ error }}</p>
    </div>

    <ng-template #loadingState>
      <p class="empty">Loading assign control page...</p>
    </ng-template>
  </div>
</section>
