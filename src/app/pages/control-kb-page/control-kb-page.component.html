<section class="page">
  <div class="panel">
    <div class="kb-skeleton" *ngIf="loading">
      <div class="filters skeleton-block">
        <div class="search-row">
          <div class="search skeleton"></div>
          <div class="skeleton skeleton-pill"></div>
          <div class="skeleton skeleton-pill"></div>
        </div>
        <div class="filter-panel">
          <div class="filter-group">
            <div class="skeleton skeleton-line"></div>
            <div class="skeleton skeleton-line"></div>
            <div class="skeleton skeleton-line"></div>
            <div class="skeleton skeleton-line"></div>
          </div>
        </div>
      </div>
      <div class="table">
        <div class="row skeleton-row" *ngFor="let _ of [1,2,3,4,5,6]">
          <div class="skeleton skeleton-line"></div>
          <div class="skeleton skeleton-line"></div>
          <div class="skeleton skeleton-line"></div>
          <div class="skeleton skeleton-line"></div>
          <div class="skeleton skeleton-line"></div>
          <div class="skeleton skeleton-pill"></div>
          <div class="skeleton skeleton-pill"></div>
          <div class="skeleton skeleton-pill"></div>
          <div class="skeleton skeleton-line"></div>
          <div class="skeleton skeleton-line"></div>
        </div>
      </div>
    </div>
    <div *ngIf="!loading">
      <div class="filters">
        <div class="search-row">
          <div class="search">
            <input
              type="search"
              placeholder="Search by control code or title..."
              [(ngModel)]="searchTerm"
              (keyup.enter)="applyFilters()"
            />
          </div>
          <button class="primary-btn" type="button" (click)="applyFilters()">Search</button>
          <button class="ghost-btn" type="button" (click)="showFilters = !showFilters">
            {{ showFilters ? 'Hide filters' : 'Search filters' }}
          </button>
          <button class="ghost-btn" type="button" *ngIf="canEdit" (click)="showNewControl = !showNewControl">
            {{ showNewControl ? 'Close' : 'New control' }}
          </button>
          <button class="ghost-btn" type="button" *ngIf="canEdit" (click)="openAssignControl()">
            Assign control
          </button>
        </div>
        <div class="filter-chips" *ngIf="activeFilterChips.length && !showFilters">
          <span class="chip" *ngFor="let chip of activeFilterChips" [title]="chip.value">
            {{ chip.label }}: {{ chip.value }}
          </span>
          <button class="ghost-btn chip-clear" type="button" (click)="clearFilters()">Clear</button>
        </div>
        <div class="filter-panel" *ngIf="showFilters">
          <div class="filter-group">
            <label>
              Framework
              <input
                type="text"
                [(ngModel)]="frameworkQuery"
                placeholder="Type to filter frameworks..."
              />
              <select [(ngModel)]="frameworkFilter" (change)="applyFilters()">
                <option value="all">All</option>
                <option *ngFor="let option of filteredFrameworkOptions" [value]="option">
                  {{ option }}
                </option>
              </select>
            </label>
            <label>
              Topic
              <select [(ngModel)]="topicFilter" (change)="applyFilters()">
                <option value="all">All</option>
                <option *ngFor="let topic of topics" [value]="topic.id">{{ topic.title }}</option>
              </select>
            </label>
            <label>
              Activation
              <select [(ngModel)]="statusFilter" (change)="applyFilters()">
                <option value="all">All</option>
                <option value="enabled">Active</option>
                <option value="disabled">Inactive</option>
              </select>
            </label>
            <label>
              Compliance
              <select [(ngModel)]="complianceFilter" (change)="applyFilters()">
                <option value="all">All</option>
                <option value="COMPLIANT">Compliant</option>
                <option value="PARTIAL">Partial</option>
                <option value="NOT_COMPLIANT">Not compliant</option>
                <option value="UNKNOWN">Unknown</option>
              </select>
            </label>
            <label>
              Evidence type
              <input
                type="text"
                [(ngModel)]="evidenceFilter"
                placeholder="Policy, Log..."
                (keyup.enter)="applyFilters()"
              />
            </label>
            <label>
              Owner role
              <input
                type="text"
                [(ngModel)]="ownerRoleFilter"
                placeholder="Security, IT..."
                (keyup.enter)="applyFilters()"
              />
            </label>
          </div>
          <div class="filter-actions">
            <button class="ghost-btn" type="button" (click)="clearFilters()">Reset</button>
          </div>
        </div>
      </div>

      <div class="draft-card" *ngIf="showNewControl && canEdit">
        <h5>New control</h5>
        <p class="empty" *ngIf="!controlDraftTopicOptions.length">
          Create a topic first to add controls.
        </p>
        <ng-container *ngIf="controlDraftTopicOptions.length">
          <div class="field">
            <label>Topic</label>
            <select [(ngModel)]="controlDraft.topicId">
              <option value="" disabled>Select topic</option>
              <option *ngFor="let topic of controlDraftTopicOptions" [value]="topic.id">{{ topic.title }}</option>
            </select>
          </div>
          <div class="field">
            <label>Control code</label>
            <input type="text" [(ngModel)]="controlDraft.controlCode" placeholder="GOV-01" />
          </div>
          <div class="field">
            <label>Title</label>
            <textarea rows="2" [(ngModel)]="controlDraft.title" placeholder="Short control statement"></textarea>
          </div>
          <div class="field">
            <label>ISO mappings</label>
            <input type="text" [(ngModel)]="controlDraft.isoMappingsText" placeholder="A.5.1, A.5.4" />
          </div>
          <button class="ghost-btn" type="button" (click)="createControl()">Add control</button>
        </ng-container>
      </div>

      <div class="table" *ngIf="controls.length; else emptyControls">
        <div class="row header">
          <span>#</span>
          <span>Control</span>
          <span>Frameworks</span>
          <span>Topic</span>
          <span>References</span>
          <span>Framework status</span>
          <span>Activation</span>
          <span>Compliance</span>
          <span>Tests</span>
          <span>Actions</span>
        </div>
        <div
          class="row item"
          *ngFor="let control of controls; let i = index"
          role="button"
          tabindex="0"
          (click)="openControlPage(control)"
          (keydown)="onControlRowKeydown(control, $event)"
        >
          <span class="index">{{ getControlIndex(i) }}</span>
          <div class="control-cell">
            <div class="control-row">
              <span class="control-code" [title]="control.controlCode">{{ control.controlCode }}</span>
            </div>
            <span class="control-title" [title]="control.title">{{ control.title }}</span>
          </div>
          <div class="framework-cell">
            <button
              class="framework-count"
              type="button"
              [disabled]="!getControlFrameworkCount(control)"
              (click)="toggleFrameworkPopover(control, $event)"
            >
              {{ getControlFrameworkCount(control) || '—' }}
            </button>
            <div class="framework-popover" *ngIf="frameworkPopoverControlId === control.id" (click)="$event.stopPropagation()">
              <div class="topic-popover-title">Frameworks</div>
              <div class="topic-popover-list">
                <div class="topic-popover-item" *ngFor="let framework of getControlFrameworkLabels(control)">
                  <span>{{ framework }}</span>
                </div>
              </div>
            </div>
          </div>
          <div class="topic-cell">
            <span class="meta truncate" [title]="getPrimaryTopicLabel(control)">{{ getPrimaryTopicLabel(control) }}</span>
            <button
              class="topic-more"
              type="button"
              *ngIf="getRelatedTopicCount(control)"
              (click)="toggleTopicPopover(control, $event)"
            >
              +{{ getRelatedTopicCount(control) }}
            </button>
            <div class="topic-popover" *ngIf="topicPopoverControlId === control.id" (click)="$event.stopPropagation()">
              <div class="topic-popover-title">Related topics</div>
              <div class="topic-popover-list">
                <div class="topic-popover-item" *ngFor="let mapping of getControlTopicMappings(control)">
                  <span>{{ mapping.title }}</span>
                  <span class="topic-tag" [class.primary]="mapping.relationshipType === 'PRIMARY'">
                    {{ mapping.relationshipType === 'PRIMARY' ? 'Primary' : 'Related' }}
                  </span>
                </div>
              </div>
            </div>
          </div>
          <span class="reference-cell" [title]="getControlReferenceCodes(control)">{{ getControlReferenceCodes(control) }}</span>
          <span class="status-pill" [ngClass]="getFrameworkStatusClass(control)">{{ getFrameworkStatusLabel(control) }}</span>
          <span class="status-pill" [ngClass]="getControlStatusClass(control)">{{ getControlStatusLabel(control) }}</span>
          <span class="status-pill" [ngClass]="getComplianceStatusClass(control)">{{ getComplianceStatusLabel(control) }}</span>
          <span class="tests">{{ control._count?.testComponents || 0 }}</span>
          <div class="action-group" (click)="$event.stopPropagation()">
            <button
              class="ghost-btn toggle-btn"
              type="button"
              *ngIf="canToggleActivation"
              [class.danger]="isControlEnabled(control)"
              (click)="toggleControlStatus(control, $event)"
            >
              {{ isControlEnabled(control) ? 'Deactivate' : 'Activate' }}
            </button>
            <button
              class="icon-btn delete-btn"
              type="button"
              *ngIf="canEdit"
              [disabled]="deletingControlId === control.id"
              [attr.aria-label]="'Delete control ' + control.controlCode"
              title="Delete control"
              (click)="deleteControl(control, $event)"
            >
              <i class="fa-solid fa-trash-can" aria-hidden="true"></i>
            </button>
          </div>
        </div>
      </div>

      <ng-template #emptyControls>
        <p class="empty">No controls found.</p>
      </ng-template>

      <div class="pagination-bar" *ngIf="totalPages > 1 || totalControls">
        <div class="pagination" *ngIf="totalPages > 1">
          <button class="ghost-btn" type="button" (click)="prevPage()" [disabled]="page === 1">Prev</button>
          <button
            class="page-btn"
            type="button"
            *ngFor="let p of pageNumbers"
            [class.active]="p === page"
            (click)="goToPage(p)"
          >
            {{ p }}
          </button>
          <button class="ghost-btn" type="button" (click)="nextPage()" [disabled]="page === totalPages">Next</button>
        </div>
        <div class="page-size">
          <label>Rows</label>
          <select [(ngModel)]="pageSize" (change)="updatePageSize(pageSize)">
            <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
          </select>
        </div>
      </div>
      <div class="page-meta" *ngIf="totalControls">Showing {{ controls.length }} of {{ totalControls }}</div>
      
    </div>

    <p class="empty" *ngIf="loading">Loading control knowledge base…</p>
    <p class="empty error" *ngIf="error">{{ error }}</p>
  </div>
</section>
