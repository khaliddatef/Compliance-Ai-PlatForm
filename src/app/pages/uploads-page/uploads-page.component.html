<section class="page">
  <div class="panel">
    <div class="panel-header">
      <div>
        <h3>Uploaded Files</h3>
        <p class="sub">Files uploaded from chat conversations.</p>
        <p class="sub" *ngIf="!loading">Total uploaded: {{ files.length }}</p>
      </div>
      <div class="header-actions">
        <button
          *ngIf="canManageStatus"
          class="secondary-btn"
          type="button"
          (click)="toggleUploadPanel()"
        >
          {{ showUploadPanel ? 'Close upload' : 'Upload files' }}
        </button>
        <button class="primary-btn" type="button" (click)="refresh()">Refresh</button>
      </div>
    </div>

    <div
      class="upload-modal-backdrop"
      *ngIf="canManageStatus && showUploadPanel"
      (click)="closeUploadPanel()"
    >
      <div class="upload-modal" (click)="$event.stopPropagation()">
        <div class="upload-modal-header">
          <div>
            <h4>Upload files</h4>
            <p>Drag and drop or choose files to upload.</p>
          </div>
          <button class="icon-btn" type="button" (click)="closeUploadPanel()">✕</button>
        </div>
        <app-upload-dropzone (filesAdded)="handleManagerUpload($event)"></app-upload-dropzone>
        <div class="manager-upload-status" *ngIf="uploadNotice || uploadError">
          <span *ngIf="uploadNotice" [class.loading]="uploading">{{ uploadNotice }}</span>
          <span class="error" *ngIf="uploadError">{{ uploadError }}</span>
        </div>
      </div>
    </div>

    <div class="filters">
      <div class="search-row">
        <input
          type="search"
          placeholder="Search uploads..."
          [(ngModel)]="searchTerm"
        />
        <div class="filter-group">
          <label>
            Framework
            <select [(ngModel)]="frameworkFilter">
              <option *ngFor="let option of frameworkOptions" [value]="option.toLowerCase() === 'all' ? 'all' : option">
                {{ option }}
              </option>
            </select>
          </label>
          <label>
            Status
            <select [(ngModel)]="statusFilter">
              <option *ngFor="let option of statusOptions" [value]="option.toLowerCase() === 'all' ? 'all' : option">
                {{ option }}
              </option>
            </select>
          </label>
          <label>
            Sort
            <select [(ngModel)]="sortMode">
              <option value="recent">Newest</option>
              <option value="oldest">Oldest</option>
              <option value="name-asc">Name A-Z</option>
              <option value="name-desc">Name Z-A</option>
              <option value="size-desc">Size: Large-Small</option>
              <option value="size-asc">Size: Small-Large</option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <div class="table skeleton-table" *ngIf="loading">
      <div class="row skeleton-row" *ngFor="let _ of [1,2,3,4,5,6]">
        <div class="skeleton skeleton-line"></div>
        <div class="skeleton skeleton-line"></div>
        <div class="skeleton skeleton-line"></div>
        <div class="skeleton skeleton-pill"></div>
        <div class="skeleton skeleton-line"></div>
        <div class="skeleton skeleton-line"></div>
        <div class="skeleton skeleton-line"></div>
        <div class="skeleton skeleton-line"></div>
      </div>
    </div>

    <div class="table" *ngIf="!loading && visibleFiles.length">
      <div class="row header">
        <span>#</span>
        <span>File</span>
        <span>Framework</span>
        <span>Status</span>
        <span>Uploaded</span>
        <span>Control reference</span>
        <span>Compliance</span>
        <span>Size</span>
        <span>Action</span>
      </div>
      <div
        class="row item-row"
        *ngFor="let file of visibleFiles; let i = index; trackBy: trackByFileId"
        role="button"
        tabindex="0"
        (click)="openUploadDetails(file)"
        (keydown)="onRowKeydown(file, $event)"
      >
        <span class="row-number" data-label="#">{{ i + 1 }}</span>
        <div class="file-cell" data-label="File">
          <span class="file-name" [title]="file.name">{{ file.name }}</span>
          <span class="file-meta" *ngIf="file.chatTitle">Chat: {{ file.chatTitle }}</span>
          <span class="file-meta" *ngIf="file.uploaderLabel">Uploaded by: {{ file.uploaderLabel }}</span>
        </div>
        <span class="framework-cell" data-label="Framework" [title]="file.framework">{{ file.framework }}</span>
        <span class="status-pill" data-label="Status" [ngClass]="file.statusClass">{{ file.status }}</span>
        <span class="date" data-label="Uploaded">{{ file.uploadedAt | date: 'MMM d, y' }}</span>
        <div class="reference-cell" data-label="Control reference">
          <ng-container *ngIf="file.frameworkReferences.length; else noReference">
            <button
              class="reference-link"
              type="button"
              *ngFor="let reference of file.frameworkReferences"
              [title]="reference"
              (click)="openFrameworkReference(reference, $event)"
            >
              {{ reference }}
            </button>
          </ng-container>
          <ng-template #noReference>
            <span class="reference-empty">—</span>
          </ng-template>
        </div>
        <div class="compliance-cell" data-label="Compliance" (click)="$event.stopPropagation()">
          <button
            *ngIf="canManageStatus; else readonlyCompliance"
            class="compliance-badge"
            type="button"
            [ngClass]="getComplianceClass(file.matchStatus)"
            (click)="toggleComplianceMenu(file.id, $event)"
          >
            <span>{{ getComplianceLabel(file.matchStatus) }}</span>
            <span class="caret">▾</span>
          </button>
          <ng-template #readonlyCompliance>
            <span class="compliance-badge" [ngClass]="getComplianceClass(file.matchStatus)">
              {{ getComplianceLabel(file.matchStatus) }}
            </span>
          </ng-template>
          <div class="compliance-menu" *ngIf="canManageStatus && openComplianceMenuId === file.id">
            <button
              class="menu-item"
              type="button"
              *ngFor="let option of complianceOptions"
              (click)="updateComplianceStatus(file, option)"
            >
              {{ getComplianceLabel(option) }}
            </button>
          </div>
        </div>
        <span data-label="Size">{{ file.size }}</span>
        <div class="action-group" data-label="Action" (click)="$event.stopPropagation()">
          <button class="menu-btn" type="button" (click)="toggleMenu(file.id, $event)">Actions</button>
          <div class="menu" *ngIf="openMenuId === file.id">
            <button class="menu-item" type="button" (click)="downloadFile(file); closeMenu()">Download</button>
            <button *ngIf="canManageStatus" class="menu-item" type="button" (click)="markReviewed(file)">
              Mark reviewed
            </button>
            <button
              *ngIf="canManageStatus && file.statusCode !== 'SUBMITTED'"
              class="menu-item highlight"
              type="button"
              (click)="markSubmitted(file)"
            >
              Submit
            </button>
            <button class="menu-item danger" type="button" (click)="deleteFile(file); closeMenu()">Delete</button>
          </div>
        </div>
      </div>
    </div>

    <p *ngIf="!loading && !visibleFiles.length && !error" class="empty">No uploads yet.</p>
    <p *ngIf="error" class="empty error">{{ error }}</p>
  </div>
</section>
