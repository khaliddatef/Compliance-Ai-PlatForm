<section class="page">
  <div class="panel">
    <div class="panel-header">
      <h3>Chat History</h3>
      <div class="search">
        <input
          type="search"
          placeholder="Search chats..."
          [(ngModel)]="searchTerm"
          (ngModelChange)="onSearchChange()"
        />
      </div>
    </div>

    <div class="history-list" *ngIf="filteredRemoteConversations.length; else remoteEmpty">
      <div class="history-item" *ngFor="let conversation of pagedRemoteConversations; let i = index; trackBy: trackByRemoteId">
        <div class="history-index" aria-hidden="true">{{ getRowNumber(i) }}</div>
        <div class="history-main">
          <div class="title">{{ getRemoteTitle(conversation) }}</div>
          <div class="meta">
            <span>{{ conversation.messageCount }} messages</span>
            <span *ngIf="isPrivileged && conversation.user?.name">By {{ conversation.user?.name }}</span>
            <span *ngIf="isPrivileged && conversation.user?.email">{{ conversation.user?.email }}</span>
            <span>Updated {{ conversation.updatedAt | date: 'short' }}</span>
          </div>
        </div>
        <div class="history-actions">
          <button class="action-btn" type="button" (click)="openRemoteConversation(conversation.id)">
            {{ isPrivileged ? 'View' : 'Open' }}
          </button>
          <button
            class="action-btn danger"
            type="button"
            (click)="deleteRemoteConversation(conversation.id, $event)"
          >
            Delete
          </button>
        </div>
      </div>
    </div>

    <div class="pagination" *ngIf="totalItems > 0">
      <div class="pagination-left">
        <button class="page-btn" type="button" (click)="prevPage()" [disabled]="currentPage === 1">Prev</button>
        <button
          class="page-btn"
          type="button"
          *ngFor="let page of pageNumbers"
          [class.page-btn--active]="page === currentPage"
          (click)="goToPage(page)"
        >
          {{ page }}
        </button>
        <button class="page-btn" type="button" (click)="nextPage()" [disabled]="currentPage === totalPages">Next</button>
      </div>
      <div class="pagination-right">
        <label class="rows-label">
          Rows
          <select [ngModel]="pageSize" (ngModelChange)="updatePageSize($event)">
            <option *ngFor="let size of pageSizeOptions" [ngValue]="size">{{ size }}</option>
          </select>
        </label>
        <span class="sub">Showing {{ showingFrom }} to {{ showingTo }} of {{ totalItems }}</span>
      </div>
    </div>

    <ng-template #remoteEmpty>
      <div class="empty" *ngIf="remoteLoading">
        <h4>Loading chats</h4>
        <p>Please wait while we load chat history.</p>
      </div>
      <div class="empty error" *ngIf="!remoteLoading && remoteError">
        <h4>Unable to load</h4>
        <p>{{ remoteError }}</p>
      </div>
      <div class="empty" *ngIf="!remoteLoading && !remoteError">
        <h4>No chats yet</h4>
        <p>Start a new chat from Home and your history will appear here.</p>
      </div>
    </ng-template>
  </div>
</section>
