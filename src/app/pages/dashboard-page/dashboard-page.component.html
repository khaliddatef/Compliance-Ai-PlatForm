<section class="page">
  <div class="dashboard-header" *ngIf="!loading && !error">
    <div>
      <h2>Dashboard</h2>
      <p>Read-only snapshot of compliance health and evidence readiness.</p>
    </div>
    <a class="cta" routerLink="/home">Continue in chat</a>
  </div>

  <div class="stats-grid" *ngIf="!loading && !error; else loadingState">
    <article class="stat-card" *ngFor="let stat of stats">
      <p class="label">{{ stat.label }}</p>
      <div class="value">{{ stat.value }}</div>
      <p class="note">{{ stat.note }}</p>
    </article>
  </div>

  <div class="grid-two" *ngIf="!loading && !error">
    <section class="panel">
      <div class="panel-header">
        <h3>Risk Heatmap</h3>
        <span class="chip">Impact vs Likelihood</span>
      </div>
      <div class="heatmap" *ngIf="riskHeatmap.length; else emptyHeatmap">
        <div class="heatmap-grid">
          <div class="heatmap-y">
            <span *ngFor="let label of impactLabels">{{ label }}</span>
          </div>
          <div class="heatmap-matrix">
            <div class="heatmap-row" *ngFor="let row of riskHeatmap; let r = index">
              <div
                class="heatmap-cell"
                *ngFor="let value of row; let c = index"
                [style.background]="getHeatmapColor(r, c)"
              >
                {{ value | number: '2.0-0' }}
              </div>
            </div>
            <div class="heatmap-x">
              <span *ngFor="let label of likelihoodLabels">{{ label }}</span>
            </div>
          </div>
        </div>
      </div>
      <ng-template #emptyHeatmap>
        <p class="empty">Heatmap data will appear once evaluations are available.</p>
      </ng-template>
    </section>

    <section class="panel">
      <div class="panel-header">
        <h3>Compliance Status Breakdown</h3>
        <span class="chip">Live distribution</span>
      </div>
      <div class="breakdown">
        <div class="donut" [style.background]="donutStyle">
          <div class="donut-center">
            <div class="donut-total">{{ complianceBreakdown.total }}</div>
            <div class="donut-label">Controls</div>
          </div>
        </div>
        <div class="breakdown-list">
          <div class="breakdown-item">
            <span class="dot compliant"></span>
            <div>
              <div class="label">Compliant</div>
              <div class="value">{{ complianceBreakdown.compliant }} ({{ complianceBreakdown.compliantPct }}%)</div>
            </div>
          </div>
          <div class="breakdown-item">
            <span class="dot partial"></span>
            <div>
              <div class="label">Partially compliant</div>
              <div class="value">{{ complianceBreakdown.partial }} ({{ complianceBreakdown.partialPct }}%)</div>
            </div>
          </div>
          <div class="breakdown-item">
            <span class="dot missing"></span>
            <div>
              <div class="label">Not compliant</div>
              <div class="value">{{ complianceBreakdown.notCompliant }} ({{ complianceBreakdown.notCompliantPct }}%)</div>
            </div>
          </div>
          <div class="breakdown-item">
            <span class="dot unknown"></span>
            <div>
              <div class="label">Unknown</div>
              <div class="value">{{ complianceBreakdown.unknown }} ({{ complianceBreakdown.unknownPct }}%)</div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <section class="panel" *ngIf="!loading && !error">
    <div class="panel-header">
      <h3>Framework Progress</h3>
      <span class="chip">Last 6 months</span>
    </div>
    <div class="progress-chart" *ngIf="frameworkProgress.length; else emptyProgress">
      <div class="chart-grid">
        <div class="chart-y">
          <span>100%</span>
          <span>75%</span>
          <span>50%</span>
          <span>25%</span>
          <span>0%</span>
        </div>
        <div class="chart-canvas">
          <svg viewBox="0 0 540 200" preserveAspectRatio="none">
            <line x1="0" y1="0" x2="540" y2="0"></line>
            <line x1="0" y1="50" x2="540" y2="50"></line>
            <line x1="0" y1="100" x2="540" y2="100"></line>
            <line x1="0" y1="150" x2="540" y2="150"></line>
            <line x1="0" y1="200" x2="540" y2="200"></line>
            <ng-container *ngFor="let series of frameworkProgress">
              <polyline [attr.points]="buildLinePoints(series.series)" [attr.stroke]="series.color"></polyline>
            </ng-container>
          </svg>
          <div class="chart-x">
            <span *ngFor="let month of frameworkMonths">{{ month }}</span>
          </div>
        </div>
      </div>
      <div class="chart-legend">
        <div class="legend-item" *ngFor="let series of frameworkProgress">
          <span class="legend-dot" [style.background]="series.color"></span>
          <span>{{ series.framework }}</span>
        </div>
      </div>
    </div>
    <ng-template #emptyProgress>
      <p class="empty">Framework progress will appear once evaluations are available.</p>
    </ng-template>
  </section>

  <section class="panel" *ngIf="!loading && !error">
    <div class="panel-header">
      <h3>Top Uploaded Controls</h3>
      <span class="chip">By document count</span>
    </div>
    <div class="table" *ngIf="uploadSummary.documentsPerControl.length; else emptyUploads">
      <div class="row header">
        <span>Control</span>
        <span>Documents</span>
        <span>Note</span>
      </div>
      <div class="row" *ngFor="let item of uploadSummary.documentsPerControl">
        <span>{{ item.controlId }}</span>
        <span>{{ item.count }}</span>
        <span>{{ item.count > 1 ? 'Multiple docs mapped' : 'Single doc mapped' }}</span>
      </div>
    </div>
    <ng-template #emptyUploads>
      <p class="empty">No uploads mapped to controls yet.</p>
    </ng-template>
  </section>

  <div class="grid-two" *ngIf="!loading && !error">
    <section class="panel">
      <div class="panel-header">
        <h3>Top Risks Not Covered</h3>
        <span class="chip">Risk-driven view</span>
      </div>
      <div class="risk-list" *ngIf="riskCoverageRows.length; else emptyRiskCoverage">
        <div class="risk-row" *ngFor="let row of riskCoverageRows">
          <div class="risk-main">
            <div class="risk-title">{{ row.title }}</div>
            <div class="risk-meta">{{ row.coverage }} covered</div>
          </div>
          <button class="risk-controls-btn" type="button" (click)="toggleRiskPopover(row.id)">
            {{ row.controlCount }} controls
          </button>
          <div class="risk-popover" *ngIf="riskPopoverId === row.id">
            <div class="risk-popover-title">Mapped controls</div>
            <div class="risk-popover-list">
              <span *ngFor="let code of row.controlCodes">{{ code }}</span>
            </div>
          </div>
        </div>
      </div>
      <ng-template #emptyRiskCoverage>
        <p class="empty">Risk coverage will appear once mappings are available.</p>
      </ng-template>
    </section>

    <section class="panel">
      <div class="panel-header">
        <h3>Controls Needing Attention</h3>
        <span class="chip">Needs attention</span>
      </div>
      <div class="table" *ngIf="riskRows.length; else emptyRisks">
        <div class="row header">
          <span>Control</span>
          <span>Owner</span>
          <span>Status</span>
          <span>Due</span>
          <span>Action</span>
        </div>
        <div class="row" *ngFor="let row of riskRows">
          <span>{{ row.control }}</span>
          <span>{{ row.owner }}</span>
          <span class="status-pill" [class.status-pill--warn]="row.status !== 'Partial'">{{ row.status }}</span>
          <span>{{ row.due }}</span>
          <button class="open-control" type="button" (click)="openControl(row)">Open</button>
        </div>
      </div>
      <ng-template #emptyRisks>
        <p class="empty">No control risks yet.</p>
      </ng-template>
    </section>
  </div>

  <section class="panel" *ngIf="!loading && !error">
    <div class="panel-header">
      <h3>Recent Activity</h3>
      <span class="chip muted">Last 48h</span>
    </div>
    <div class="activity-list" *ngIf="activityRows.length; else emptyActivity">
      <div class="activity" *ngFor="let item of activityRows">
        <div class="activity-main">
          <div class="activity-title">{{ item.item }}</div>
          <div class="activity-meta">{{ item.by }}</div>
        </div>
        <div class="activity-time">{{ item.time }}</div>
      </div>
    </div>
    <ng-template #emptyActivity>
      <p class="empty">No recent activity.</p>
    </ng-template>
  </section>

  <ng-template #loadingState>
    <p class="empty" *ngIf="loading">Loading dashboardâ€¦</p>
    <p class="empty error" *ngIf="error">{{ error }}</p>
  </ng-template>
</section>
