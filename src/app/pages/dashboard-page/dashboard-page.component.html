<section class="page">
  <div class="dashboard-header" *ngIf="!loading && !error">
    <div class="header-copy">
      <h2>Executive Compliance Dashboard</h2>
      <p>Action-driven snapshot of compliance health, evidence, and risk posture.</p>
      <p class="framework-scope" *ngIf="appliedFrameworkLabel">Framework scope: {{ appliedFrameworkLabel }}</p>
      <div class="exec-summary" *ngIf="executiveMode && executiveSummary">
        <div class="exec-headline">{{ executiveSummary.headline }}</div>
        <div class="exec-highlights">
          <span *ngFor="let item of executiveSummary.highlights">{{ item }}</span>
        </div>
        <div class="exec-risks">
          <span *ngFor="let item of executiveSummary.risks">{{ item }}</span>
        </div>
      </div>
    </div>
    <div class="header-actions">
      <button class="export-btn" type="button" (click)="exportExecutivePdf()">Export PDF</button>
      <a class="cta" routerLink="/home">Continue in chat</a>
    </div>
  </div>

  <section class="panel snapshot" *ngIf="!loading && !error">
    <div class="panel-header">
      <h3>Executive Snapshot</h3>
    </div>
    <div class="kpi-grid">
      <button class="kpi-card" type="button" *ngFor="let kpi of kpis" (click)="openKpi(kpi)">
        <div class="kpi-header">
          <span class="kpi-label" [title]="getKpiTooltip(kpi)">{{ kpi.label }}</span>
          <span class="severity-badge" [class]="getSeverityClass(kpi.severity || 'low')">{{ kpi.severity || 'low' }}</span>
        </div>
        <div class="kpi-value">{{ kpi.value }}</div>
      </button>
    </div>
  </section>

  <div class="grid-two" *ngIf="!loading && !error && !executiveMode">
    <section class="panel risk-panel">
      <div class="panel-header risk-header">
        <div>
          <h3>Risk Heatmap</h3>
          <div class="risk-summary">
            <span class="risk-summary-label">Overall Risk Exposure</span>
            <span [class]="getRiskBadgeClass()">{{ riskExposureLabel }}</span>
          </div>
        </div>
        <button
          class="ghost clear-filter"
          type="button"
          *ngIf="hasRiskFilter"
          (click)="clearRiskFilters()"
        >
          Clear filter
        </button>
      </div>
      <div class="heatmap risk-heatmap">
        <div class="heatmap-grid">
          <div class="heatmap-y">
            <span *ngFor="let label of impactLabels">{{ label }}</span>
          </div>
          <div class="heatmap-matrix">
            <div class="heatmap-row" *ngFor="let row of riskHeatmap; let rowIndex = index">
              <button
                class="heatmap-cell"
                type="button"
                *ngFor="let cell of row; let colIndex = index"
                [class.empty]="cell === 0"
                [class.filled]="cell > 0"
                [class.selected]="isHeatmapCellSelected(rowIndex, colIndex)"
                [style.background]="getHeatmapColor(rowIndex, colIndex, cell)"
                [attr.title]="getHeatmapTooltip(rowIndex, colIndex, cell)"
                [disabled]="cell === 0"
                [attr.aria-disabled]="cell === 0"
                (click)="openControlsForHeatmapCell(rowIndex, colIndex, cell, $event)"
              >
                <span
                  class="heatmap-count"
                  [class.muted]="cell === 0"
                >
                  {{ formatHeatmapValue(cell) }}
                </span>
              </button>
            </div>
            <div class="heatmap-x">
              <span *ngFor="let label of likelihoodLabels">{{ label }}</span>
            </div>
          </div>
        </div>
      </div>
      <div class="risk-drivers-block">
        <div class="gap-header">
          <div>
            <h4>Top Risk Drivers</h4>
            <p *ngIf="riskDriversContext; else riskDriversSubtitle">{{ riskDriversContext }}</p>
            <ng-template #riskDriversSubtitle>
              <p>Primary factors contributing to current risk exposure</p>
            </ng-template>
          </div>
        </div>
        <div class="gap-chart" *ngIf="riskDrivers.length; else emptyRiskDrivers">
          <button
            class="gap-row risk-driver-row"
            type="button"
            *ngFor="let driver of riskDrivers; let idx = index"
            [class.active]="selectedRiskDriverId === driver.id"
            [attr.title]="getRiskDriverTooltip(driver)"
            [attr.aria-pressed]="selectedRiskDriverId === driver.id"
            (click)="toggleRiskDriver(driver.id)"
          >
            <span class="gap-label">{{ driver.label }}</span>
            <span class="gap-bar">
              <span class="gap-fill" [style.width.%]="getRiskDriverWidth(driver)" [style.background]="getRiskDriverColor(idx)"></span>
            </span>
            <span class="gap-count">{{ driver.count }}</span>
          </button>
        </div>
        <ng-template #emptyRiskDrivers>
          <p class="empty">No major risk drivers identified.</p>
        </ng-template>
      </div>
      <div class="risk-filter" *ngIf="hasRiskFilter">
        <div class="risk-filter-header">
          <div>
            <h4>Filtered risks</h4>
            <p>{{ selectedRiskFilterLabel }}</p>
          </div>
        </div>
        <div class="risk-list" *ngIf="filteredRiskControls.length; else emptyRiskFilter">
          <div class="risk-row" *ngFor="let item of filteredRiskControls">
            <div class="risk-main">
              <div class="risk-title">{{ item.controlCode }} — {{ item.title }}</div>
              <div class="risk-meta">Status: {{ formatStatusLabel(item.status) }}</div>
            </div>
          </div>
        </div>
        <ng-template #emptyRiskFilter>
          <p class="empty">No risks match this filter.</p>
        </ng-template>
      </div>
    </section>

    <section class="panel clickable" (click)="openStat('compliance')" role="button" tabindex="0">
      <div class="panel-header">
        <h3>Compliance Status</h3>
      </div>
      <div class="donut" [style.background]="donutStyle">
        <div class="donut-center">
          <div class="donut-total">{{ complianceBreakdown.total }}</div>
          <div class="donut-label">Controls</div>
        </div>
      </div>
      <div class="legend-list">
        <button class="legend-item legend-button" type="button" (click)="openComplianceStatus('COMPLIANT', $event)">
          <span class="dot compliant"></span>Compliant {{ complianceBreakdown.compliant }}
        </button>
        <button class="legend-item legend-button" type="button" (click)="openComplianceStatus('PARTIAL', $event)">
          <span class="dot partial"></span>Partial {{ complianceBreakdown.partial }}
        </button>
        <button class="legend-item legend-button" type="button" (click)="openComplianceStatus('NOT_COMPLIANT', $event)">
          <span class="dot missing"></span>Non-compliant {{ complianceBreakdown.notCompliant }}
        </button>
        <button class="legend-item legend-button" type="button" (click)="openComplianceStatus('UNKNOWN', $event)">
          <span class="dot unknown"></span>Unknown {{ complianceBreakdown.unknown }}
        </button>
      </div>
      <div class="gap-chart" *ngIf="complianceGaps.length; else emptyGaps">
        <div class="gap-header">
          <div>
            <h4>Top Compliance Gaps</h4>
            <p>Main reasons controls are not compliant</p>
          </div>
        </div>
        <button
          class="gap-row"
          type="button"
          *ngFor="let gap of complianceGaps"
          (click)="openGap(gap, $event)"
        >
          <span class="gap-label">{{ gap.label }}</span>
          <span class="gap-bar">
            <span class="gap-fill" [style.width.%]="getGapWidth(gap)" [style.background]="getGapColor(gap)"></span>
          </span>
          <span class="gap-count">{{ gap.count }}</span>
        </button>
      </div>
      <ng-template #emptyGaps>
        <p class="empty">No major compliance gaps detected.</p>
      </ng-template>
    </section>
  </div>

  <section class="panel attention" *ngIf="!loading && !error && !executiveMode">
    <div class="panel-header">
      <h3>What Needs Attention</h3>
    </div>
    <div class="attention-grid" *ngIf="attentionToday.length; else emptyAttention">
      <button class="attention-card" type="button" *ngFor="let item of attentionToday" (click)="openAttention(item)">
        <div class="attention-meta">
          <span class="attention-label">{{ item.label }}</span>
          <span class="attention-hint">{{ getAttentionHint(item) }}</span>
        </div>
        <span class="attention-count">{{ item.count }}</span>
      </button>
    </div>
    <ng-template #emptyAttention>
      <p class="empty">All good today.</p>
    </ng-template>
  </section>

  <section class="panel trends" *ngIf="!loading && !error">
    <div class="panel-header">
      <h3>Trends</h3>
      <div class="trend-toggle">
        <button class="ghost" type="button" [class.active]="rangeDays === 30" (click)="setTrendRange(30)">30d</button>
        <button class="ghost" type="button" [class.active]="rangeDays === 90" (click)="setTrendRange(90)">90d</button>
      </div>
    </div>
    <div class="trend-grid" *ngIf="trendsV2.length; else emptyTrends">
      <section class="panel trend-panel clickable" *ngFor="let series of trendsV2" (click)="openTrend(series)" role="button" tabindex="0">
        <div class="trend-title">{{ series.label }}</div>
        <div class="trend-chart" [title]="getTrendTooltip(series)">
          <svg viewBox="0 0 540 200" preserveAspectRatio="none">
            <line x1="0" y1="0" x2="540" y2="0"></line>
            <line x1="0" y1="50" x2="540" y2="50"></line>
            <line x1="0" y1="100" x2="540" y2="100"></line>
            <line x1="0" y1="150" x2="540" y2="150"></line>
            <line x1="0" y1="200" x2="540" y2="200"></line>
            <polyline [attr.points]="buildLinePoints(series.points, series.unit === 'days' ? getTrendMax(series) : 100)">
              <title>{{ series.label }} latest {{ formatTrendValue(series, getTrendLatest(series)) }}</title>
            </polyline>
          </svg>
          <div class="chart-x">
            <span *ngFor="let label of series.dates.slice(-6)">{{ label }}</span>
          </div>
        </div>
      </section>
    </div>
    <ng-template #emptyTrends>
      <p class="empty">Trend data will appear once evaluations are available.</p>
    </ng-template>
  </section>

  <section class="panel" *ngIf="!loading && !error && !executiveMode">
    <button class="panel-toggle" type="button" (click)="toggleEvidence()">
      <h3>Evidence Health</h3>
      <span class="chevron" [class.open]="evidenceOpen">▾</span>
    </button>
    <div class="panel-body" *ngIf="evidenceOpen">
      <div class="stacked-bar">
        <div class="segment valid" [style.width.%]="getEvidenceSegmentPct('valid')"></div>
        <div class="segment expiring" [style.width.%]="getEvidenceSegmentPct('expiring')"></div>
        <div class="segment expired" [style.width.%]="getEvidenceSegmentPct('expired')"></div>
        <div class="segment missing" [style.width.%]="getEvidenceSegmentPct('missing')"></div>
      </div>
      <div class="legend-list">
        <div class="legend-item"><span class="dot compliant"></span>Valid {{ evidenceHealthVisual.valid }}</div>
        <div class="legend-item"><span class="dot partial"></span>Expiring {{ evidenceHealthVisual.expiringSoon }}</div>
        <div class="legend-item"><span class="dot missing"></span>Expired {{ evidenceHealthVisual.expired }}</div>
        <div class="legend-item"><span class="dot unknown"></span>Missing {{ evidenceHealthVisual.missing }}</div>
      </div>
    </div>
  </section>


  <div *ngIf="loading || error">
    <p class="empty" *ngIf="loading">Loading dashboard...</p>
    <p class="empty error" *ngIf="error">{{ error }}</p>
  </div>
</section>
