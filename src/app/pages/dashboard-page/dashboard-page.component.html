<section class="page">
  <div class="dashboard-header" *ngIf="!loading && !error">
    <div class="header-copy">
      <h2>Executive Compliance Dashboard</h2>
      <p>Action-driven snapshot of compliance health, evidence, and risk posture.</p>
      <div class="exec-summary" *ngIf="executiveMode && executiveSummary">
        <div class="exec-headline">{{ executiveSummary.headline }}</div>
        <div class="exec-highlights">
          <span *ngFor="let item of executiveSummary.highlights">{{ item }}</span>
        </div>
        <div class="exec-risks">
          <span *ngFor="let item of executiveSummary.risks">{{ item }}</span>
        </div>
      </div>
    </div>
    <div class="header-actions">
      <button class="ghost" type="button" (click)="toggleExecutive()">Executive View</button>
      <button class="ghost" type="button" (click)="exportExecutivePdf()" [disabled]="!executiveMode">Export PDF</button>
      <a class="cta" routerLink="/home">Continue in chat</a>
    </div>
  </div>

  <section class="panel snapshot" *ngIf="!loading && !error">
    <div class="panel-header">
      <h3>Executive Snapshot</h3>
    </div>
    <div class="kpi-grid">
      <button class="kpi-card" type="button" *ngFor="let kpi of kpis" (click)="openKpi(kpi)">
        <div class="kpi-header">
          <span class="kpi-label" [title]="getKpiTooltip(kpi)">{{ kpi.label }}</span>
          <span class="severity-badge" [class]="getSeverityClass(kpi.severity || 'low')">{{ kpi.severity || 'low' }}</span>
        </div>
        <div class="kpi-value">{{ kpi.value }}</div>
      </button>
    </div>
  </section>

  <div class="grid-two" *ngIf="!loading && !error && !executiveMode">
    <section class="panel clickable" (click)="openStat('risk')" role="button" tabindex="0">
      <div class="panel-header">
        <h3>Risk Distribution</h3>
      </div>
      <div class="donut" [style.background]="riskDonutStyle">
        <div class="donut-center">
          <div class="donut-total">{{ riskDistribution.exposure | uppercase }}</div>
          <div class="donut-label">Exposure</div>
        </div>
      </div>
      <div class="legend-list">
        <div class="legend-item"><span class="dot high"></span>High {{ riskDistribution.high }}</div>
        <div class="legend-item"><span class="dot medium"></span>Medium {{ riskDistribution.medium }}</div>
        <div class="legend-item"><span class="dot low"></span>Low {{ riskDistribution.low }}</div>
      </div>
      <div class="heatmap">
        <div class="panel-header">
          <h4>Risk Heatmap</h4>
        </div>
        <div class="heatmap-grid">
          <div class="heatmap-y">
            <span *ngFor="let label of impactLabels">{{ label }}</span>
          </div>
          <div class="heatmap-matrix">
            <div class="heatmap-row" *ngFor="let row of riskHeatmap; let rowIndex = index">
              <div
                class="heatmap-cell"
                *ngFor="let cell of row; let colIndex = index"
                [style.background]="getHeatmapColor(rowIndex, colIndex)"
              >
                {{ cell }}
              </div>
            </div>
            <div class="heatmap-x">
              <span *ngFor="let label of likelihoodLabels">{{ label }}</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="panel clickable" (click)="openStat('compliance')" role="button" tabindex="0">
      <div class="panel-header">
        <h3>Compliance Status</h3>
      </div>
      <div class="donut" [style.background]="donutStyle">
        <div class="donut-center">
          <div class="donut-total">{{ complianceBreakdown.total }}</div>
          <div class="donut-label">Controls</div>
        </div>
      </div>
      <div class="legend-list">
        <div class="legend-item"><span class="dot compliant"></span>Compliant {{ complianceBreakdown.compliant }}</div>
        <div class="legend-item"><span class="dot partial"></span>Partial {{ complianceBreakdown.partial }}</div>
        <div class="legend-item"><span class="dot missing"></span>Non-compliant {{ complianceBreakdown.notCompliant }}</div>
        <div class="legend-item"><span class="dot unknown"></span>Unknown {{ complianceBreakdown.unknown }}</div>
      </div>
      <div class="gap-chart" *ngIf="complianceGaps.length; else emptyGaps">
        <div class="gap-header">
          <div>
            <h4>Top Compliance Gaps</h4>
            <p>Main reasons controls are not compliant</p>
          </div>
        </div>
        <button
          class="gap-row"
          type="button"
          *ngFor="let gap of complianceGaps"
          (click)="openGap(gap, $event)"
        >
          <span class="gap-label">{{ gap.label }}</span>
          <span class="gap-bar">
            <span class="gap-fill" [style.width.%]="getGapWidth(gap)" [style.background]="getGapColor(gap)"></span>
          </span>
          <span class="gap-count">{{ gap.count }}</span>
        </button>
      </div>
      <ng-template #emptyGaps>
        <p class="empty">No major compliance gaps detected.</p>
      </ng-template>
    </section>
  </div>

  <section class="panel attention" *ngIf="!loading && !error && !executiveMode">
    <div class="panel-header">
      <h3>What Needs Attention</h3>
    </div>
    <div class="attention-grid" *ngIf="attentionToday.length; else emptyAttention">
      <button class="attention-card" type="button" *ngFor="let item of attentionToday" (click)="openAttention(item)">
        <span class="attention-label">{{ item.label }}</span>
        <span class="attention-count">{{ item.count }}</span>
      </button>
    </div>
    <ng-template #emptyAttention>
      <p class="empty">All good today.</p>
    </ng-template>
  </section>

  <section class="panel trends" *ngIf="!loading && !error">
    <div class="panel-header">
      <h3>Trends</h3>
      <div class="trend-toggle">
        <button class="ghost" type="button" [class.active]="rangeDays === 30" (click)="setTrendRange(30)">30d</button>
        <button class="ghost" type="button" [class.active]="rangeDays === 90" (click)="setTrendRange(90)">90d</button>
      </div>
    </div>
    <div class="trend-grid" *ngIf="trendsV2.length; else emptyTrends">
      <section class="panel trend-panel clickable" *ngFor="let series of trendsV2" (click)="openTrend(series)" role="button" tabindex="0">
        <div class="trend-title">{{ series.label }}</div>
        <div class="trend-chart" [title]="getTrendTooltip(series)">
          <svg viewBox="0 0 540 200" preserveAspectRatio="none">
            <line x1="0" y1="0" x2="540" y2="0"></line>
            <line x1="0" y1="50" x2="540" y2="50"></line>
            <line x1="0" y1="100" x2="540" y2="100"></line>
            <line x1="0" y1="150" x2="540" y2="150"></line>
            <line x1="0" y1="200" x2="540" y2="200"></line>
            <polyline [attr.points]="buildLinePoints(series.points, series.unit === 'days' ? getTrendMax(series) : 100)">
              <title>{{ series.label }} latest {{ formatTrendValue(series, getTrendLatest(series)) }}</title>
            </polyline>
          </svg>
          <div class="chart-x">
            <span *ngFor="let label of series.dates.slice(-6)">{{ label }}</span>
          </div>
        </div>
      </section>
    </div>
    <ng-template #emptyTrends>
      <p class="empty">Trend data will appear once evaluations are available.</p>
    </ng-template>
  </section>

  <section class="panel" *ngIf="!loading && !error && !executiveMode">
    <button class="panel-toggle" type="button" (click)="toggleEvidence()">
      <h3>Evidence Health</h3>
      <span class="chevron" [class.open]="evidenceOpen">▾</span>
    </button>
    <div class="panel-body" *ngIf="evidenceOpen">
      <div class="stacked-bar">
        <div class="segment valid" [style.width.%]="getEvidenceSegmentPct('valid')"></div>
        <div class="segment expiring" [style.width.%]="getEvidenceSegmentPct('expiring')"></div>
        <div class="segment expired" [style.width.%]="getEvidenceSegmentPct('expired')"></div>
        <div class="segment missing" [style.width.%]="getEvidenceSegmentPct('missing')"></div>
      </div>
      <div class="legend-list">
        <div class="legend-item"><span class="dot compliant"></span>Valid {{ evidenceHealthVisual.valid }}</div>
        <div class="legend-item"><span class="dot partial"></span>Expiring {{ evidenceHealthVisual.expiringSoon }}</div>
        <div class="legend-item"><span class="dot missing"></span>Expired {{ evidenceHealthVisual.expired }}</div>
        <div class="legend-item"><span class="dot unknown"></span>Missing {{ evidenceHealthVisual.missing }}</div>
      </div>
    </div>
  </section>

  <section class="panel" *ngIf="!loading && !error && !executiveMode">
    <button class="panel-toggle" type="button" (click)="toggleFrameworkComparison()">
      <h3>Framework Comparison</h3>
      <span class="chevron" [class.open]="frameworkOpen">▾</span>
    </button>
    <div class="panel-body" *ngIf="frameworkOpen">
      <div class="comparison-list" *ngIf="frameworkComparisonV2.length; else emptyComparison">
        <div class="comparison-row" *ngFor="let row of frameworkComparisonV2" (click)="openFrameworkComparison(row)">
          <div class="comparison-meta">
            <div class="comparison-title">{{ row.framework }}</div>
            <div class="comparison-sub">{{ row.completionPercent }}% complete - {{ row.failedControls }} failed</div>
          </div>
          <div class="comparison-bar">
            <span class="bar compliant" [style.width.%]="row.totalControls ? (row.compliant / row.totalControls) * 100 : 0"></span>
            <span class="bar partial" [style.width.%]="row.totalControls ? (row.partial / row.totalControls) * 100 : 0"></span>
            <span class="bar notcompliant" [style.width.%]="row.totalControls ? (row.notCompliant / row.totalControls) * 100 : 0"></span>
            <span class="bar unknown" [style.width.%]="row.totalControls ? (row.unknown / row.totalControls) * 100 : 0"></span>
          </div>
        </div>
      </div>
      <ng-template #emptyComparison>
        <p class="empty">Framework comparison will appear once evaluations are available.</p>
      </ng-template>
    </div>
  </section>

  <div *ngIf="loading || error">
    <p class="empty" *ngIf="loading">Loading dashboard...</p>
    <p class="empty error" *ngIf="error">{{ error }}</p>
  </div>
</section>
